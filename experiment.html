<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gaze Estimation Experiment</title>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <script src="/mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI',system-ui,sans-serif;background:#0d1117;color:#e6edf3;min-height:100vh}
    .phase{display:none;min-height:100vh}
    .phase.active{display:flex;flex-direction:column}

    /* â”€â”€ Camera widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #cam-widget{margin-top:20px;display:flex;flex-direction:column;align-items:center;gap:6px}
    #cam-video-wrap{position:relative;width:240px;height:180px;border-radius:10px;border:2px solid #30363d;overflow:hidden;background:#0d1117}
    #cam-preview{width:240px;height:180px;object-fit:cover;display:block;transform:scaleX(-1)}
    #cam-canvas{position:absolute;top:0;left:0;width:240px;height:180px;pointer-events:none;transform:scaleX(-1)}
    #cam-status{font-size:.75rem;color:#8b949e}

    /* â”€â”€ Gaze dots (one per method) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .gaze-dot-m{
      position:fixed;width:18px;height:18px;border-radius:50%;
      transform:translate(-50%,-50%);pointer-events:none;
      z-index:8500;display:none
    }
    #gaze-dot-webgazer{background:rgba(88,166,255,0.55);border:2px solid #58a6ff;box-shadow:0 0 10px rgba(88,166,255,0.8)}
    #gaze-dot-iris-linear{background:rgba(63,185,80,0.55);border:2px solid #3fb950;box-shadow:0 0 10px rgba(63,185,80,0.8)}
    #gaze-dot-iris-poly{background:rgba(240,192,0,0.55);border:2px solid #f0c000;box-shadow:0 0 10px rgba(240,192,0,0.8)}

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn{padding:10px 22px;border-radius:8px;border:none;cursor:pointer;font-size:.9rem;font-weight:600;transition:opacity .2s,background .2s}
    .btn:disabled{opacity:.35;cursor:not-allowed}
    .btn-green{background:#238636;color:#fff}.btn-green:hover:not(:disabled){background:#2ea043}
    .btn-blue{background:#1f6feb;color:#fff}.btn-blue:hover:not(:disabled){background:#388bfd}
    .btn-grey{background:#21262d;color:#e6edf3;border:1px solid #30363d}.btn-grey:hover:not(:disabled){background:#30363d}
    .btn-save{background:#6e40c9;color:#fff}.btn-save:hover:not(:disabled){background:#8957e5}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap}

    /* â”€â”€ Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.72rem;font-weight:700}
    .tag-wg{background:rgba(88,166,255,.2);color:#58a6ff}
    .tag-ml{background:rgba(63,185,80,.2);color:#3fb950}
    .tag-poly{background:rgba(240,192,0,.2);color:#f0c000}

    /* â”€â”€ Phase 0 â€“ Landing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #ph-select{align-items:center;justify-content:center;padding:40px 20px;text-align:center}
    #ph-select h1{font-size:1.8rem;color:#58a6ff;margin-bottom:8px}
    .method-info-box{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;max-width:800px;width:100%;margin:0 auto 28px;text-align:left}
    .mib{background:#161b22;border:2px solid #30363d;border-radius:12px;padding:18px 16px}
    .mib h3{font-size:.95rem;margin-bottom:4px}
    .mib p{color:#8b949e;font-size:.8rem;line-height:1.5}
    .mib-wg h3{color:#58a6ff}.mib-ml h3{color:#3fb950}.mib-poly h3{color:#f0c000}
    .cal-ctrl{display:flex;align-items:center;gap:14px;margin-bottom:20px;flex-wrap:wrap;justify-content:center}
    .cal-ctrl label{color:#8b949e;font-size:.85rem;display:flex;align-items:center;gap:6px}
    .cal-ctrl input{width:54px;padding:4px 6px;border-radius:6px;border:1px solid #30363d;background:#0d1117;color:#e6edf3;font-size:.85rem;text-align:center}
    #runs-list h3{color:#8b949e;font-size:.85rem;margin-bottom:8px;letter-spacing:.5px}
    .run-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:#161b22;border:1px solid #30363d;border-radius:6px;margin-bottom:6px;font-size:.82rem;cursor:pointer}
    .run-item:hover{background:#1c2128}
    .ri-exp{color:#8b949e;min-width:40px;font-size:.75rem}
    .ri-scores{display:flex;gap:12px;flex:1}
    .ri-score{font-size:.82rem;font-weight:600}
    .ri-time{color:#8b949e;font-size:.75rem}

    /* â”€â”€ Phase 1 â€“ Calibration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #ph-calibrate{position:relative;background:#0d1117}
    #cal-overlay{position:fixed;inset:0;background:rgba(13,17,23,.96);z-index:900;display:none}
    #cal-overlay.show{display:block}
    .cal-dot{position:absolute;width:42px;height:42px;border-radius:50%;transform:translate(-50%,-50%);cursor:pointer;border:3px solid #58a6ff;background:rgba(88,166,255,.1);display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;color:#58a6ff;user-select:none;transition:border-color .2s}
    .cal-dot.active{border-color:#f0c000;color:#f0c000;background:rgba(240,192,0,.15);animation:cpulse .8s infinite}
    .cal-dot.done{border-color:#3fb950;color:#3fb950;background:rgba(63,185,80,.2);cursor:default;transform:translate(-50%,-50%) scale(.85)}
    @keyframes cpulse{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.18)}}
    #cal-info{position:fixed;top:25%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none;z-index:910;background:rgba(13,17,23,.88);border:1px solid #30363d;border-radius:10px;padding:14px 24px;backdrop-filter:blur(6px);min-width:360px}
    #cal-info h2{color:#58a6ff;margin-bottom:6px;font-size:1rem}
    #cal-info p{color:#8b949e;font-size:.82rem;line-height:1.5}
    #cal-prog{color:#e6edf3;margin-top:6px;font-size:.9rem}
    #cal-bar-wrap{width:200px;height:6px;background:#21262d;border-radius:3px;margin:10px auto 0;overflow:hidden}
    #cal-bar-fill{height:100%;width:0%;background:#f0c000;border-radius:3px;transition:width .1s}
    #cal-msg{margin-top:10px;font-size:.8rem;color:#f85149;min-height:18px}

    /* â”€â”€ Experiment 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #ph-experiment{position:relative;background:#0d1117;justify-content:center;align-items:center}
    #exp-dot{position:fixed;width:32px;height:32px;border-radius:50%;transform:translate(-50%,-50%);background:rgba(240,192,0,.9);border:3px solid #f0c000;box-shadow:0 0 24px rgba(240,192,0,.7);display:none;z-index:810;pointer-events:none}
    #exp-dot.show{display:block}
    #exp-status{position:fixed;top:25%;left:50%;transform:translate(-50%,-50%);background:rgba(22,27,34,.92);border:1px solid #30363d;border-radius:10px;padding:14px 28px;text-align:center;z-index:820;min-width:280px}
    #exp-status h3{color:#58a6ff;font-size:1rem;margin-bottom:4px}
    #exp-timer{font-size:2.2rem;font-weight:700;color:#e6edf3;margin:4px 0}
    #exp-progress{font-size:.82rem;color:#8b949e}
    #exp-collect-badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:.75rem;font-weight:700;margin-top:6px;background:rgba(248,81,73,.2);color:#f85149}
    #exp-collect-badge.collecting{background:rgba(63,185,80,.2);color:#3fb950}
    .dot-legend{display:flex;gap:10px;justify-content:center;margin-top:8px;flex-wrap:wrap}
    .dot-legend-item{display:flex;align-items:center;gap:4px;font-size:.72rem;color:#8b949e}
    .dot-legend-circle{width:10px;height:10px;border-radius:50%}

    /* â”€â”€ Experiment 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #ph-experiment2{position:relative;background:#0d1117;justify-content:center;align-items:center}
    #exp2-para-wrap{max-width:860px;width:90%;text-align:justify;line-height:2.4;font-size:1.45rem;padding:120px 20px 60px;user-select:none}
    .exp2-word{color:rgba(230,237,243,.25);font-weight:700;transition:color .12s;cursor:default;display:inline}
    .exp2-word.active{color:#f0c000;text-shadow:0 0 20px rgba(240,192,0,.6)}
    .exp2-word.done{color:rgba(63,185,80,.45)}
    #exp2-status{position:fixed;top:50%;left:16px;transform:translateY(-50%);background:rgba(22,27,34,.92);border:1px solid #30363d;border-radius:10px;padding:12px 20px;text-align:center;z-index:820;min-width:200px}
    #exp2-status h3{color:#58a6ff;font-size:1rem;margin-bottom:4px}
    #exp2-timer{font-size:2rem;font-weight:700;color:#e6edf3;margin:4px 0}
    #exp2-progress{font-size:.82rem;color:#8b949e}
    #exp2-collect-badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:.75rem;font-weight:700;margin-top:6px;background:rgba(248,81,73,.2);color:#f85149}
    #exp2-collect-badge.collecting{background:rgba(63,185,80,.2);color:#3fb950}

    /* â”€â”€ Experiment 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #ph-experiment3{position:relative;background:#0d1117;justify-content:center;align-items:center}
    #exp3-bg{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:background .5s}
    #exp3-arrow{font-size:8rem;line-height:1;margin-bottom:8px;color:#fff;opacity:.9;user-select:none}
    #exp3-instruction{font-size:2.6rem;font-weight:800;color:#fff;margin-bottom:6px;letter-spacing:1px}
    #exp3-subtext{font-size:1rem;color:rgba(255,255,255,.6);margin-bottom:24px;max-width:420px;text-align:center;line-height:1.5}
    #exp3-timer-wrap{font-size:4.5rem;font-weight:900;color:#fff;width:90px;height:90px;border-radius:50%;border:3px solid rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;margin-bottom:20px}
    #exp3-badge{padding:4px 16px;border-radius:12px;font-size:.8rem;font-weight:700;background:rgba(248,81,73,.25);color:#f85149;margin-bottom:24px}
    #exp3-proceed-btn{display:none;padding:12px 40px;border-radius:8px;border:none;background:#238636;color:#fff;font-size:1rem;font-weight:700;cursor:pointer;transition:background .2s}
    #exp3-proceed-btn:hover{background:#2ea043}
    #exp3-progress{position:fixed;top:16px;right:20px;color:rgba(255,255,255,.5);font-size:.85rem}

    /* â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #ph-results{padding:40px 24px;overflow-y:auto;justify-content:flex-start}
    .results-hdr{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;margin-bottom:28px}
    .results-hdr h1{color:#58a6ff;font-size:1.4rem}
    .results-hdr .sub{color:#8b949e;font-size:.85rem;margin-top:4px}
    .section{margin-bottom:40px}
    .section h2{color:#58a6ff;font-size:1rem;margin-bottom:16px;border-bottom:1px solid #21262d;padding-bottom:8px;letter-spacing:.3px}
    .method-summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px}
    .ms-card{background:#161b22;border:2px solid #30363d;border-radius:10px;padding:14px 16px}
    .ms-card h4{font-size:.88rem;margin-bottom:6px}
    .ms-card-wg{border-color:rgba(88,166,255,.4)}.ms-card-wg h4{color:#58a6ff}
    .ms-card-ml{border-color:rgba(63,185,80,.4)}.ms-card-ml h4{color:#3fb950}
    .ms-card-poly{border-color:rgba(240,192,0,.4)}.ms-card-poly h4{color:#f0c000}
    .ms-big{font-size:2rem;font-weight:700;color:#e6edf3}
    .ms-label{font-size:.75rem;color:#8b949e;margin-top:2px}
    .chart-scroll{overflow-x:auto;padding-bottom:8px}
    .chart-wrap{min-width:500px;height:300px}
    .tbl{width:100%;border-collapse:collapse}
    .tbl th,.tbl td{padding:8px 12px;text-align:left;border-bottom:1px solid #21262d;font-size:.83rem}
    .tbl th{color:#8b949e;font-weight:600}
    .tbl td{color:#e6edf3}
    .tbl tr.total td{font-weight:700;color:#58a6ff;border-bottom:none}
    .hm-grid{display:grid;gap:8px}
    .hm-grid.cols3{grid-template-columns:repeat(3,1fr)}
    .hm-header-row{display:grid;gap:8px;margin-bottom:4px}
    .hm-header-row.cols3{grid-template-columns:repeat(3,1fr)}
    .hm-cell{background:#161b22;border:1px solid #30363d;border-radius:6px;padding:6px;text-align:center}
    .hm-cell img{width:100%;height:auto;border-radius:4px;display:block}
    .hm-row-label{font-size:.72rem;color:#8b949e;padding:6px 0 2px;font-weight:600}
    #toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#238636;color:#fff;padding:10px 24px;border-radius:8px;font-size:.88rem;z-index:9999;display:none;pointer-events:none}

    /* â”€â”€ Experiment / ready selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .exp-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;max-width:1020px;width:100%;margin:0 auto 28px}
    .ec{background:#161b22;border:2px solid #30363d;border-radius:12px;padding:24px 20px;cursor:pointer;transition:border-color .2s,transform .15s;text-align:left}
    .ec:hover{border-color:#58a6ff;transform:translateY(-2px)}
    .ec h3{color:#58a6ff;font-size:1rem;margin-bottom:8px}
    .ec p{color:#8b949e;font-size:.82rem;line-height:1.5}
    .ec .tag{margin-bottom:8px;display:inline-block}

    @media(max-width:700px){
      .method-info-box,.method-summary-grid,.exp-grid,.hm-grid.cols3,.hm-header-row.cols3{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

<!-- â”€â”€â”€ Three gaze dots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="gaze-dot-webgazer"    class="gaze-dot-m"></div>
<div id="gaze-dot-iris-linear" class="gaze-dot-m"></div>
<div id="gaze-dot-iris-poly"   class="gaze-dot-m"></div>
<div id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PHASE 0 â€“ Landing
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ph-select" class="phase active">
  <h1 style="color:#58a6ff;font-size:1.9rem;margin-bottom:6px">Eye Gaze Estimation Experiment</h1>
  <p style="color:#8b949e;margin-bottom:24px">Calibrate once â€” then all 3 methods run simultaneously in each experiment</p>

  <div class="method-info-box">
    <div class="mib mib-wg">
      <h3>WebGazer <span class="tag tag-wg">Method 1</span></h3>
      <p>Ridge Regression on eye-patch appearance features via WebGazer.js. Gaze dot shown in <b style="color:#58a6ff">blue</b>.</p>
    </div>
    <div class="mib mib-ml">
      <h3>Iris Linear <span class="tag tag-ml">Method 2</span></h3>
      <p>Linear regression on iris-to-eye-corner ratio features via MediaPipe. Gaze dot shown in <b style="color:#3fb950">green</b>.</p>
    </div>
    <div class="mib mib-poly">
      <h3>Iris Polynomial <span class="tag tag-poly">Method 3</span></h3>
      <p>Polynomial regression on iris position (6 features). Gaze dot shown in <b style="color:#f0c000">yellow</b>.</p>
    </div>
  </div>

  <div class="cal-ctrl">
    <label>
      Clicks per calibration dot:
      <input id="wg-clicks-input" type="number" min="1" max="20" value="5"/>
    </label>
    <button class="btn btn-green" onclick="beginCalibration()">Start Calibration â†’</button>
  </div>

  <div id="runs-list" style="display:none;max-width:900px;width:100%;text-align:left;margin-bottom:24px">
    <h3>COMPLETED RUNS</h3>
    <div id="runs-list-inner"></div>
    <div style="margin-top:12px;display:flex;gap:10px">
      <button class="btn btn-blue" onclick="showPhase('ph-results')">View Latest Results</button>
      <button class="btn btn-grey" onclick="clearAllRuns()">Clear All</button>
    </div>
  </div>

  <div id="cam-widget">
    <div id="cam-video-wrap">
      <video id="cam-preview" autoplay playsinline muted></video>
      <canvas id="cam-canvas"></canvas>
    </div>
    <div id="cam-status">Starting cameraâ€¦</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PHASE 1 â€“ Calibration overlay
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ph-calibrate" class="phase">
  <div id="cal-overlay">
    <div id="cal-info">
      <h2 id="cal-title">Calibration â€” All 3 Methods</h2>
      <p id="cal-desc"></p>
      <div id="cal-prog"></div>
      <div id="cal-bar-wrap"><div id="cal-bar-fill"></div></div>
      <div id="cal-msg"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PHASE 2 â€“ Pre-experiment briefing
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ph-ready" class="phase" style="align-items:center;justify-content:center;padding:40px 20px">
  <div style="max-width:580px;width:100%;background:#161b22;border:1px solid #30363d;border-radius:14px;padding:36px 40px;text-align:center">
    <div style="font-size:2rem;margin-bottom:12px">ğŸ‘</div>
    <h2 id="ready-title" style="color:#58a6ff;margin-bottom:6px">Calibration Complete</h2>
    <p style="color:#8b949e;font-size:.85rem;margin-bottom:24px">All 3 methods will run simultaneously during the experiment</p>
    <div id="ready-instructions" style="text-align:left;background:#0d1117;border-radius:10px;padding:20px 24px;margin-bottom:28px;font-size:.88rem;line-height:1.8"></div>
    <button class="btn btn-green" onclick="startCurrentExperiment()" style="font-size:1rem;padding:12px 40px">Start Experiment â†’</button>
    <div style="margin-top:12px">
      <button class="btn btn-grey" onclick="showPhase('ph-exp-select')" style="font-size:.8rem">â† Back</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PHASE 2b â€“ Experiment selection
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ph-exp-select" class="phase" style="align-items:center;justify-content:center;padding:40px 20px;text-align:center">
  <h1 style="color:#58a6ff;font-size:1.6rem;margin-bottom:6px">Choose Experiment</h1>
  <p id="exp-sel-status" style="color:#8b949e;font-size:.88rem;margin-bottom:28px">âœ“ Calibrated â€” all 3 methods ready</p>
  <div class="exp-grid">
    <div class="ec" onclick="selectExperiment(1)">
      <span class="tag tag-wg">Experiment 1</span>
      <h3>Fixation Accuracy</h3>
      <p>9 static target dots appear one by one. Look at each dot steadily. All 3 methods measure gaze accuracy simultaneously.</p>
    </div>
    <div class="ec" onclick="selectExperiment(2)">
      <span class="tag tag-ml">Experiment 2</span>
      <h3>Reading Task</h3>
      <p>A paragraph shown word by word. Look at each highlighted word. All 3 methods compare gaze accuracy during natural reading.</p>
    </div>
    <div class="ec" onclick="selectExperiment(3)">
      <span class="tag tag-poly">Experiment 3</span>
      <h3>Off-Screen Robustness</h3>
      <p>Look outside the screen in 4 directions for 5 s each. Counts how many gaze estimates land on-screen â€” fewer is better.</p>
    </div>
  </div>
  <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
    <button class="btn btn-grey" onclick="doRecalibrate()">â†º Recalibrate</button>
    <button class="btn btn-grey" onclick="showPhase('ph-select')">â† Menu</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PHASE 3 â€“ Experiment 1
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ph-experiment" class="phase">
  <div id="exp-dot"></div>
  <div id="exp-status">
    <h3>All 3 Methods</h3>
    <div id="exp-timer">â€“</div>
    <div id="exp-progress">Dot 1 / 9</div>
    <div id="exp-collect-badge">Waiting 1sâ€¦</div>
    <div class="dot-legend">
      <div class="dot-legend-item"><div class="dot-legend-circle" style="background:#58a6ff"></div>WebGazer</div>
      <div class="dot-legend-item"><div class="dot-legend-circle" style="background:#3fb950"></div>Iris Linear</div>
      <div class="dot-legend-item"><div class="dot-legend-circle" style="background:#f0c000"></div>Iris Poly</div>
    </div>
    <div style="margin-top:8px">
      <button id="btn-toggle-gaze" onclick="toggleGazeDot()"
        style="padding:4px 12px;border-radius:6px;border:1px solid #58a6ff;background:#21262d;color:#58a6ff;font-size:.72rem;cursor:pointer">
        Show Gaze [H]
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PHASE 4 â€“ Experiment 2
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ph-experiment2" class="phase">
  <div id="exp2-status">
    <h3>All 3 Methods</h3>
    <div id="exp2-timer">â€“</div>
    <div id="exp2-progress">Word 1 / â€“</div>
    <div id="exp2-collect-badge">Waitingâ€¦</div>
    <div class="dot-legend" style="margin-top:8px">
      <div class="dot-legend-item"><div class="dot-legend-circle" style="background:#58a6ff"></div>WG</div>
      <div class="dot-legend-item"><div class="dot-legend-circle" style="background:#3fb950"></div>IL</div>
      <div class="dot-legend-item"><div class="dot-legend-circle" style="background:#f0c000"></div>IP</div>
    </div>
    <div style="margin-top:8px">
      <button id="btn-toggle-gaze2" onclick="toggleGazeDot()"
        style="padding:4px 12px;border-radius:6px;border:1px solid #58a6ff;background:#21262d;color:#58a6ff;font-size:.72rem;cursor:pointer">
        Show Gaze [H]
      </button>
    </div>
  </div>
  <div id="exp2-para-wrap"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PHASE 4b â€“ Experiment 3
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ph-experiment3" class="phase">
  <div id="exp3-bg">
    <div id="exp3-arrow"></div>
    <div id="exp3-instruction"></div>
    <div id="exp3-subtext"></div>
    <div id="exp3-timer-wrap"></div>
    <div id="exp3-badge">Waitingâ€¦</div>
    <button id="exp3-proceed-btn" onclick="exp3Proceed()">Next direction â†’</button>
    <div id="exp3-progress"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PHASE 5 â€“ Results
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ph-results" class="phase">
  <div class="results-hdr">
    <div>
      <h1 id="res-title">Results</h1>
      <div class="sub" id="res-subtitle"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-green" onclick="runAnotherExperiment()">Run Another</button>
      <button class="btn btn-grey" onclick="doRecalibrate()">â†º Recalibrate</button>
      <button class="btn btn-save" onclick="saveResults()">â¬‡ Save Results</button>
      <button class="btn btn-grey" onclick="takeScreenshot()">ğŸ“· Screenshot</button>
      <button class="btn btn-grey" onclick="showPhase('ph-select')">â† Menu</button>
    </div>
  </div>

  <div class="section" id="sec-summary">
    <h2>Method Comparison â€” Overall</h2>
    <div class="method-summary-grid" id="method-summary-cards"></div>
  </div>

  <div class="section" id="sec-chart">
    <h2 id="sec-chart-title">Gaze Error per Target â€” All 3 Methods</h2>
    <div class="chart-scroll"><div class="chart-wrap"><canvas id="comparison-chart"></canvas></div></div>
  </div>

  <div class="section" id="sec-table">
    <h2 id="sec-table-title">Detailed Results Table</h2>
    <div style="overflow-x:auto">
      <table class="tbl" id="results-table">
        <thead><tr id="results-thead"></tr></thead>
        <tbody id="results-tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="section" id="sec-heatmaps" style="display:none">
    <h2 id="sec-heatmaps-title">Heatmaps</h2>
    <div id="heatmaps-container"></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CAL_POSITIONS_PCT = [
  [10,10],[50,10],[90,10],
  [10,50],[50,50],[90,50],
  [10,90],[50,90],[90,90]
];
const METHODS = ['webgazer','iris-linear','iris-poly'];
const METHOD_LABELS = {'webgazer':'WebGazer','iris-linear':'Iris Linear','iris-poly':'Iris Poly'};
const METHOD_COLORS = {'webgazer':'#58a6ff','iris-linear':'#3fb950','iris-poly':'#f0c000'};
const METHOD_CSS    = {'webgazer':'ms-card-wg','iris-linear':'ms-card-ml','iris-poly':'ms-card-poly'};

let DOT_DURATION_MS  = 5000;
const SKIP_MS        = 1000;
const SAMPLE_INTERVAL = 67;
const WG_CLICKS_PER_ROUND = 5;
let WG_CLICKS_NEEDED = 5;

const EXP3_DIRECTIONS = [
  {id:'right', label:'RIGHT',arrow:'â†’',bg:'#071629',subtext:'Move your gaze to the RIGHT â€” outside the screen edge'},
  {id:'left',  label:'LEFT', arrow:'â†',bg:'#071e10',subtext:'Move your gaze to the LEFT â€” outside the screen edge'},
  {id:'top',   label:'UP',   arrow:'â†‘',bg:'#1e1b07',subtext:'Move your gaze UPWARD â€” above the top of the screen'},
  {id:'bottom',label:'DOWN', arrow:'â†“',bg:'#1e0707',subtext:'Move your gaze DOWNWARD â€” below the bottom of the screen'},
];
const EXP3_DURATION_MS = 5000;
const EXP3_SKIP_MS     = 500;

const EXP2_PARAGRAPH =
  'The Transformer architecture introduced by Vaswani et al in 2017 revolutionized ' +
  'natural language processing through its self-attention mechanism which allows each ' +
  'token to directly attend to every other token in a sequence. ' +
  'Unlike recurrent networks that process tokens sequentially Transformers operate in ' +
  'parallel enabling efficient scaling to billions of parameters. ' +
  'Positional encodings are added to token embeddings so the model retains awareness ' +
  'of word order despite its non-sequential design. ' +
  'Variational Autoencoders proposed by Kingma and Welling learn continuous latent ' +
  'representations by encoding inputs as Gaussian distributions in a lower dimensional space. ' +
  'During training the model minimizes reconstruction loss while regularizing the latent ' +
  'space through KL divergence ensuring the learned distribution stays close to a standard normal. ' +
  'By sampling from this structured space VAEs can generate diverse and semantically coherent ' +
  'outputs making them powerful tools for generative modeling in both vision and language domains.';
const EXP2_WORDS = EXP2_PARAGRAPH.replace(/[.,]/g,'').split(/\s+/).filter(w=>w.length>0);
let EXP2_WORD_DURATION_MS = 300;
let EXP2_WORD_SKIP_MS     = 100;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let selectedExperiment = null;
let isCalibrated       = false;
let allRuns            = [];
let latestRunIdx       = -1;

// Camera / MediaPipe
let videoEl      = null;
let camStream    = null;
let faceMesh     = null;
let faceLoopId   = null;
let currentLM    = null;
let selectDrawId = null;

// Calibration (unified â€” feeds all 3 methods simultaneously)
let calIndex      = 0;
let irisCalData   = [];  // [{lx,ly,rx,ry,sx,sy}] accumulated per click
let calModel_iris_linear = null;
let calModel_iris_poly   = null;
let wgClickCount  = 0;
let calDotEls     = [];
let calTotalRounds = 1;
let calRound       = 0;
let calDotTotal    = [];

// WebGazer
let wgRunning = false;
let wgGaze    = null;

// Gaze dot visibility (H key toggles all 3)
let gazeVisible = false;

// Experiment 1 state (method-keyed)
let expDotIndex    = 0;
let expSamples     = {};  // {webgazer:[], iris-linear:[], iris-poly:[]}
let expResults     = {};
let expSampleId    = null;
let expDotTimer    = null;
let expCountdownId = null;
let expDotStart    = null;

// Experiment 2 state (method-keyed)
let exp2WordIndex   = 0;
let exp2Samples     = {};
let exp2Results     = {};
let exp2SampleId    = null;
let exp2WordTimer   = null;
let exp2CountdownId = null;
let exp2WordStart   = null;

// Experiment 3 state (method-keyed per direction)
let exp3DirIndex    = 0;
let exp3Samples     = {};  // per current direction, method-keyed
let exp3Results     = [];  // [{dirIdx, dirId, dirLabel, dirArrow, methods:{webgazer:{...},...}}]
let exp3SampleId    = null;
let exp3TimerId     = null;
let exp3CountdownId = null;
let exp3DirStart    = null;

// Chart instances
let compChartInst  = null;
let chartInstances = [];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MATRIX MATH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function matTranspose(A){return A[0].map((_,j)=>A.map(r=>r[j]));}
function matMul(A,B){
  const m=A.length,n=B[0].length,k=B.length;
  const C=Array.from({length:m},()=>new Array(n).fill(0));
  for(let i=0;i<m;i++) for(let j=0;j<n;j++) for(let l=0;l<k;l++) C[i][j]+=A[i][l]*B[l][j];
  return C;
}
function solveGaussian(A,b){
  const n=A.length,M=A.map((row,i)=>[...row,b[i]]);
  for(let col=0;col<n;col++){
    let mx=col;
    for(let r=col+1;r<n;r++) if(Math.abs(M[r][col])>Math.abs(M[mx][col])) mx=r;
    [M[col],M[mx]]=[M[mx],M[col]];
    if(Math.abs(M[col][col])<1e-12) continue;
    for(let r=0;r<n;r++){
      if(r===col) continue;
      const f=M[r][col]/M[col][col];
      for(let k2=col;k2<=n;k2++) M[r][k2]-=f*M[col][k2];
    }
  }
  return M.map((row,i)=>row[n]/row[i]);
}
function fitModel(featureMatrix,targets){
  const X=featureMatrix,XT=matTranspose(X),XTX=matMul(XT,X);
  const XTy_x=matMul(XT,targets.map(t=>[t[0]])).map(r=>r[0]);
  const XTy_y=matMul(XT,targets.map(t=>[t[1]])).map(r=>r[0]);
  return{theta_x:solveGaussian(XTX.map(r=>[...r]),[...XTy_x]),
         theta_y:solveGaussian(XTX.map(r=>[...r]),[...XTy_y])};
}
function modelPredict(model,fv){
  return{x:fv.reduce((s,v,i)=>s+v*model.theta_x[i],0),
         y:fv.reduce((s,v,i)=>s+v*model.theta_y[i],0)};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IRIS FEATURE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function extractIrisFeatures(){
  if(!currentLM||currentLM.length<478) return null;
  const lm=currentLM;
  const W=videoEl?(videoEl.videoWidth||640):640;
  const H=videoEl?(videoEl.videoHeight||480):480;
  const px=pt=>({x:pt.x*W,y:pt.y*H});
  const lo=px(lm[33]),li=px(lm[133]),lu=px(lm[160]),ll=px(lm[144]),lc=px(lm[468]);
  const lew=Math.abs(lo.x-li.x)||1,leh=Math.abs(lu.y-ll.y)||1;
  const lx=(lc.x-Math.min(lo.x,li.x))/lew,ly=(lc.y-Math.min(lu.y,ll.y))/leh;
  const ro=px(lm[362]),ri=px(lm[263]),ru=px(lm[385]),rl=px(lm[373]),rc=px(lm[473]);
  const rew=Math.abs(ro.x-ri.x)||1,reh=Math.abs(ru.y-rl.y)||1;
  const rx=(rc.x-Math.min(ro.x,ri.x))/rew,ry=(rc.y-Math.min(ru.y,rl.y))/reh;
  return{lx,ly,rx,ry};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAZE ESTIMATION (per method)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getCurrentGaze(method){
  if(method==='webgazer') return wgGaze?{...wgGaze}:null;
  const model=method==='iris-linear'?calModel_iris_linear:calModel_iris_poly;
  if(!model) return null;
  const feat=extractIrisFeatures();
  if(!feat) return null;
  let fv;
  if(method==='iris-linear'){
    fv=[1,feat.lx,feat.ly,feat.rx,feat.ry];
  } else {
    const ax=(feat.lx+feat.rx)/2,ay=(feat.ly+feat.ry)/2;
    fv=[1,ax,ay,ax*ax,ay*ay,ax*ay];
  }
  return modelPredict(model,fv);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAMERA & MEDIAPIPE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function initCamera(){
  if(camStream) return;
  videoEl=document.getElementById('cam-preview');
  camStream=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480,facingMode:'user'}});
  videoEl.srcObject=camStream;
  await new Promise(r=>videoEl.addEventListener('loadeddata',r,{once:true}));
}
async function initFaceMesh(){
  if(faceMesh) return;
  if(typeof FaceMesh==='undefined') throw new Error('MediaPipe FaceMesh not loaded');
  faceMesh=new FaceMesh({locateFile:f=>`/mediapipe/face_mesh/${f}`});
  faceMesh.setOptions({maxNumFaces:1,refineLandmarks:true,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
  faceMesh.onResults(res=>{currentLM=(res.multiFaceLandmarks&&res.multiFaceLandmarks[0])||null;});
  await faceMesh.initialize();
}
function startFaceLoop(){
  if(faceLoopId) return;
  async function loop(){
    if(videoEl&&videoEl.readyState>=2&&!videoEl.paused) try{await faceMesh.send({image:videoEl});}catch(_){}
    faceLoopId=setTimeout(loop,66);
  }
  loop();
}
function stopFaceLoop(){clearTimeout(faceLoopId);faceLoopId=null;}
function startSelectDraw(){
  if(selectDrawId||!faceMesh) return;
  const canvas=document.getElementById('cam-canvas');
  if(!canvas) return;
  canvas.width=240;canvas.height=180;
  function loop(){
    const ctx=canvas.getContext('2d');
    ctx.clearRect(0,0,240,180);
    if(currentLM){
      ctx.fillStyle='rgba(88,166,255,0.85)';
      currentLM.forEach(({x,y})=>{ctx.beginPath();ctx.arc(x*240,y*180,1,0,Math.PI*2);ctx.fill();});
    }
    selectDrawId=setTimeout(loop,66);
  }
  loop();
}
function stopSelectDraw(){clearTimeout(selectDrawId);selectDrawId=null;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showPhase(id){
  document.querySelectorAll('.phase').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='ph-select'){if(!faceLoopId) startFaceLoop();startSelectDraw();}
  else stopSelectDraw();
}
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.display='block';
  setTimeout(()=>t.style.display='none',2500);
}
function updateGazeDot(method,x,y){
  if(method===null){
    METHODS.forEach(m=>{const d=document.getElementById('gaze-dot-'+m);if(d)d.style.display='none';});
    return;
  }
  const d=document.getElementById('gaze-dot-'+method);
  if(!d) return;
  if(x==null||!gazeVisible){d.style.display='none';return;}
  d.style.display='block';d.style.left=x+'px';d.style.top=y+'px';
}
function pctToPx(pct){return{x:window.innerWidth*pct[0]/100,y:window.innerHeight*pct[1]/100};}
function toggleGazeDot(){
  gazeVisible=!gazeVisible;
  ['btn-toggle-gaze','btn-toggle-gaze2'].forEach(id=>{
    const btn=document.getElementById(id);if(!btn) return;
    btn.textContent=gazeVisible?'Hide Gaze [H]':'Show Gaze [H]';
    btn.style.color=gazeVisible?'#8b949e':'#58a6ff';
    btn.style.borderColor=gazeVisible?'#30363d':'#58a6ff';
  });
  if(!gazeVisible) updateGazeDot(null,null,null);
}
function avg(arr){return arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALIBRATION (unified â€” click feeds all 3 methods)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function beginCalibration(){
  const clicksInput=document.getElementById('wg-clicks-input');
  WG_CLICKS_NEEDED=Math.min(20,Math.max(1,parseInt(clicksInput.value)||5));
  showPhase('ph-calibrate');

  calIndex=0;irisCalData=[];calModel_iris_linear=null;calModel_iris_poly=null;
  wgGaze=null;wgClickCount=0;
  calTotalRounds=Math.ceil(WG_CLICKS_NEEDED/WG_CLICKS_PER_ROUND);
  calRound=0;calDotTotal=new Array(9).fill(0);
  chartInstances.forEach(c=>c.destroy());chartInstances=[];

  const overlay=document.getElementById('cal-overlay');
  overlay.classList.add('show');
  calDotEls.forEach(d=>d.remove());calDotEls=[];

  const nClicks=wgClicksForRound(0);
  document.getElementById('cal-title').textContent='Calibration â€” All 3 Methods';
  document.getElementById('cal-desc').innerHTML=
    'Look at each <span style="color:#f0c000">yellow dot</span> and '+
    '<b>click it '+nClicks+' times</b>.<br>'+
    'Each click calibrates WebGazer + both Iris models simultaneously.<br>'+
    calTotalRounds+' round'+(calTotalRounds>1?'s':'')+' Ã— '+WG_CLICKS_PER_ROUND+
    ' clicks = <b>'+WG_CLICKS_NEEDED+' total</b> per dot';
  document.getElementById('cal-bar-wrap').style.display='none';
  document.getElementById('cal-msg').textContent='';

  // Start WebGazer
  try{
    if(wgRunning){webgazer.end();wgRunning=false;}
    await webgazer.setGazeListener(data=>{if(data) wgGaze={x:data.x,y:data.y};}).begin();
    webgazer.showPredictionPoints(false);webgazer.showVideo(false);
    webgazer.showFaceOverlay(false);webgazer.showFaceFeedbackBox(false);
    wgRunning=true;
  }catch(e){document.getElementById('cal-msg').textContent='WebGazer error: '+e.message;return;}

  // Start camera + MediaPipe for iris calibration
  try{
    if(!camStream) await initCamera();
    if(!faceMesh) await initFaceMesh();
    if(!faceLoopId) startFaceLoop();
  }catch(e){document.getElementById('cal-msg').textContent='Camera error: '+e.message;}

  buildCalDots(overlay,onCalDotClick);
  activateCalDot(0);
  updateCalProgText();
}

function wgClicksForRound(round){
  const remainder=WG_CLICKS_NEEDED%WG_CLICKS_PER_ROUND;
  const isLast=round===calTotalRounds-1;
  return(isLast&&remainder!==0)?remainder:Math.min(WG_CLICKS_PER_ROUND,WG_CLICKS_NEEDED);
}
function updateCalProgText(){
  document.getElementById('cal-prog').textContent=
    'Round '+(calRound+1)+' / '+calTotalRounds+'  â€¢  Dot '+(calIndex+1)+' / 9';
}

function onCalDotClick(idx){
  if(idx!==calIndex) return;
  const dot=calDotEls[idx];
  const {x,y}=pctToPx(CAL_POSITIONS_PCT[idx]);
  const roundMax=wgClicksForRound(calRound);

  // Feed WebGazer
  webgazer.recordScreenPosition(x,y,'click');

  // Capture iris features for iris models
  const feat=extractIrisFeatures();
  if(feat) irisCalData.push({...feat,sx:x,sy:y});

  wgClickCount++;calDotTotal[idx]++;
  dot.textContent=calDotTotal[idx]+'/'+WG_CLICKS_NEEDED;
  dot.style.fontSize='.65rem';

  if(wgClickCount>=roundMax){
    wgClickCount=0;dot.classList.remove('active');
    if(calIndex<8){
      calIndex++;activateCalDot(calIndex);updateCalProgText();
    } else {
      calRound++;
      if(calRound>=calTotalRounds){
        calDotEls.forEach(d=>{d.classList.remove('active');d.classList.add('done');d.textContent='âœ“';d.style.fontSize='';});
        finishCalibration();
      } else {
        const nextClicks=wgClicksForRound(calRound);
        calDotEls.forEach((d,i)=>{
          d.classList.remove('active','done');
          d.textContent=calDotTotal[i]+'/'+WG_CLICKS_NEEDED;d.style.fontSize='.65rem';
        });
        document.getElementById('cal-desc').innerHTML=
          'Round '+(calRound+1)+' of '+calTotalRounds+' â€” click each dot <b>'+nextClicks+' more times</b>';
        calIndex=0;activateCalDot(0);updateCalProgText();
      }
    }
  }
}

function finishCalibration(){
  if(irisCalData.length>=4){
    calModel_iris_linear=fitModel(
      irisCalData.map(d=>[1,d.lx,d.ly,d.rx,d.ry]),
      irisCalData.map(d=>[d.sx,d.sy])
    );
    calModel_iris_poly=fitModel(
      irisCalData.map(d=>{const ax=(d.lx+d.rx)/2,ay=(d.ly+d.ry)/2;return[1,ax,ay,ax*ax,ay*ay,ax*ay];}),
      irisCalData.map(d=>[d.sx,d.sy])
    );
  }
  isCalibrated=true;
  document.getElementById('cal-prog').textContent='âœ“ All 3 methods calibrated!';
  document.getElementById('cal-overlay').classList.remove('show');
  setTimeout(showExpSelectPhase,600);
}

function buildCalDots(overlay,clickHandler){
  CAL_POSITIONS_PCT.forEach(([lp,tp],i)=>{
    const d=document.createElement('div');
    d.className='cal-dot';d.style.left=lp+'%';d.style.top=tp+'%';d.textContent=i+1;
    d.addEventListener('click',()=>clickHandler(i));
    overlay.appendChild(d);calDotEls.push(d);
  });
}
function activateCalDot(idx){calDotEls.forEach((d,i)=>d.classList.toggle('active',i===idx));}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showExpSelectPhase(){
  isCalibrated=true;
  document.getElementById('exp-sel-status').textContent='âœ“ Calibrated â€” all 3 methods ready';
  showPhase('ph-exp-select');
}
function selectExperiment(n){selectedExperiment=n;showReadyPhase();}
function doRecalibrate(){isCalibrated=false;calModel_iris_linear=null;calModel_iris_poly=null;wgGaze=null;beginCalibration();}
function runAnotherExperiment(){showExpSelectPhase();}
function startCurrentExperiment(){
  if(selectedExperiment===1) startExperiment();
  else if(selectedExperiment===2) startExperiment2();
  else if(selectedExperiment===3) startExperiment3();
}

function showReadyPhase(){
  document.getElementById('ready-title').textContent='Ready â€” Experiment '+selectedExperiment;
  const kbdStyle='background:#21262d;border:1px solid #30363d;border-radius:4px;padding:1px 5px;font-size:.8rem;color:#e6edf3';
  const hKey=`<kbd style="${kbdStyle}">H</kbd>`;
  const inStyle='width:64px;padding:3px 6px;border-radius:6px;border:1px solid #30363d;background:#0d1117;color:#e6edf3;font-size:.85rem;text-align:center';
  let html='<div style="color:#e6edf3;font-weight:600;margin-bottom:10px">How this experiment works</div>';
  if(selectedExperiment===1){
    html+=`<ul style="color:#8b949e;padding-left:18px;margin:0">
      <li><span style="color:#e6edf3">9 dots</span> appear one by one on screen</li>
      <li>Each dot shown for a configurable duration (default <span style="color:#e6edf3">5 s</span>)</li>
      <li>First <span style="color:#e6edf3">1 s</span> settling pause â€” move gaze to dot</li>
      <li>All 3 methods collect gaze data simultaneously (~15 samples/s)</li>
      <li>Press ${hKey} to show/hide the 3 colored gaze dots</li>
    </ul>
    <div style="margin-top:14px;display:flex;gap:20px;align-items:center">
      <label style="display:flex;align-items:center;gap:8px;color:#8b949e;font-size:.85rem">
        Dot duration (s):<input id="exp1-duration-input" type="number" min="1" max="30" step="1" value="5" style="${inStyle}"/>
      </label>
    </div>`;
  } else if(selectedExperiment===2){
    html+=`<ul style="color:#8b949e;padding-left:18px;margin:0">
      <li>A paragraph about <span style="color:#e6edf3">Transformers &amp; VAEs</span> is displayed</li>
      <li><span style="color:#e6edf3">Look at and read aloud</span> each highlighted word</li>
      <li>Total: <span style="color:#e6edf3">${EXP2_WORDS.length} words</span></li>
      <li>All 3 methods collect gaze simultaneously per word</li>
      <li>Press ${hKey} to show/hide the 3 colored gaze dots</li>
    </ul>
    <div style="margin-top:14px;display:flex;gap:20px;align-items:center;flex-wrap:wrap">
      <label style="display:flex;align-items:center;gap:8px;color:#8b949e;font-size:.85rem">
        Settle time (s):<input id="exp2-settle-input" type="number" min="0.05" max="2" step="0.05" value="0.1" style="${inStyle}"/>
      </label>
      <label style="display:flex;align-items:center;gap:8px;color:#8b949e;font-size:.85rem">
        Collect time (s):<input id="exp2-collect-input" type="number" min="0.1" max="5" step="0.05" value="0.2" style="${inStyle}"/>
      </label>
    </div>`;
  } else if(selectedExperiment===3){
    html+=`<ul style="color:#8b949e;padding-left:18px;margin:0">
      <li>Screen changes colour showing a <span style="color:#e6edf3">direction arrow</span></li>
      <li>Look <span style="color:#e6edf3">outside the screen</span> in that direction for <span style="color:#e6edf3">5 seconds</span></li>
      <li>First <span style="color:#e6edf3">0.5 s</span> settling pause â€” all 3 methods then collect data</li>
      <li>After 5 s, click <span style="color:#e6edf3">Next</span> to proceed</li>
      <li>4 directions: <span style="color:#e6edf3">Right â†’ Left â†’ Up â†’ Down</span></li>
      <li>Metric: on-screen gaze points while looking away â€” <span style="color:#e6edf3">fewer = better</span></li>
    </ul>`;
  }
  document.getElementById('ready-instructions').innerHTML=html;
  showPhase('ph-ready');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEATMAP RENDERING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderHeatmap(samples,gtX,gtY){
  const W=window.innerWidth,H=window.innerHeight;
  const canvas=document.createElement('canvas');canvas.width=W;canvas.height=H;
  const ctx=canvas.getContext('2d');ctx.fillStyle='#0d1117';ctx.fillRect(0,0,W,H);
  const r=60;
  samples.forEach(({x,y})=>{
    const g=ctx.createRadialGradient(x,y,0,x,y,r);
    g.addColorStop(0,'rgba(255,80,80,0.28)');g.addColorStop(0.5,'rgba(255,200,0,0.09)');g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=g;ctx.fillRect(Math.max(0,x-r),Math.max(0,y-r),r*2,r*2);
  });
  ctx.beginPath();ctx.arc(gtX,gtY,10,0,Math.PI*2);
  ctx.strokeStyle='#58a6ff';ctx.lineWidth=2;ctx.stroke();
  ctx.beginPath();ctx.moveTo(gtX-8,gtY);ctx.lineTo(gtX+8,gtY);ctx.stroke();
  ctx.beginPath();ctx.moveTo(gtX,gtY-8);ctx.lineTo(gtX,gtY+8);ctx.stroke();
  return canvas.toDataURL('image/png');
}
function renderHeatmapExp3(samples){
  const W=window.innerWidth,H=window.innerHeight;
  const canvas=document.createElement('canvas');canvas.width=W;canvas.height=H;
  const ctx=canvas.getContext('2d');ctx.fillStyle='#0d1117';ctx.fillRect(0,0,W,H);
  const r=60;
  samples.forEach(({x,y})=>{
    const g=ctx.createRadialGradient(x,y,0,x,y,r);
    g.addColorStop(0,'rgba(255,80,80,0.28)');g.addColorStop(0.5,'rgba(255,200,0,0.09)');g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=g;ctx.fillRect(Math.max(0,x-r),Math.max(0,y-r),r*2,r*2);
  });
  ctx.strokeStyle='rgba(88,166,255,0.55)';ctx.lineWidth=2;ctx.setLineDash([8,4]);
  ctx.strokeRect(2,2,W-4,H-4);ctx.setLineDash([]);
  return canvas.toDataURL('image/png');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPERIMENT 1 â€” FIXATION ACCURACY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startExperiment(){
  const durS=parseFloat(document.getElementById('exp1-duration-input')?.value)||5;
  DOT_DURATION_MS=Math.round(Math.max(1,durS)*1000);
  expDotIndex=0;
  expSamples={'webgazer':[],'iris-linear':[],'iris-poly':[]};
  expResults={'webgazer':[],'iris-linear':[],'iris-poly':[]};
  gazeVisible=false;updateGazeDot(null,null,null);
  const btn=document.getElementById('btn-toggle-gaze');
  if(btn){btn.textContent='Show Gaze [H]';btn.style.color='#58a6ff';btn.style.borderColor='#58a6ff';}
  if(wgRunning) try{webgazer.removeMouseEventListeners();}catch(_){}
  showPhase('ph-experiment');
  setTimeout(showNextDot,500);
}

function showNextDot(){
  if(expDotIndex>=CAL_POSITIONS_PCT.length){finishExperiment();return;}
  const pct=CAL_POSITIONS_PCT[expDotIndex];
  const {x,y}=pctToPx(pct);
  const dot=document.getElementById('exp-dot');
  dot.style.left=x+'px';dot.style.top=y+'px';dot.classList.add('show');
  document.getElementById('exp-progress').textContent='Dot '+(expDotIndex+1)+' / 9';
  const badge=document.getElementById('exp-collect-badge');
  badge.textContent='Waiting 1 sâ€¦';badge.className='exp-collect-badge';
  METHODS.forEach(m=>expSamples[m]=[]);
  expDotStart=performance.now();
  let elapsed=0;
  const timerEl=document.getElementById('exp-timer');
  timerEl.textContent=(DOT_DURATION_MS/1000).toFixed(0);
  if(expCountdownId) clearInterval(expCountdownId);
  expCountdownId=setInterval(()=>{
    elapsed+=100;
    timerEl.textContent=Math.max(0,(DOT_DURATION_MS-elapsed)/1000).toFixed(1);
    if(elapsed>=DOT_DURATION_MS){clearInterval(expCountdownId);expCountdownId=null;}
  },100);
  setTimeout(()=>{
    badge.textContent='â— Collectingâ€¦';badge.className='exp-collect-badge collecting';
    expSampleId=setInterval(collectGazeSample,SAMPLE_INTERVAL);
  },SKIP_MS);
  expDotTimer=setTimeout(()=>{
    clearInterval(expSampleId);clearInterval(expCountdownId);expCountdownId=null;
    dot.classList.remove('show');updateGazeDot(null,null,null);
    METHODS.forEach(m=>{
      expResults[m].push({gtX:x,gtY:y,pct,samples:[...expSamples[m]],heatmapUrl:renderHeatmap([...expSamples[m]],x,y)});
    });
    expDotIndex++;setTimeout(showNextDot,500);
  },DOT_DURATION_MS);
}

function collectGazeSample(){
  const pct=CAL_POSITIONS_PCT[expDotIndex];
  const {x:gtX,y:gtY}=pctToPx(pct);
  const t=(performance.now()-expDotStart-SKIP_MS)/1000;
  METHODS.forEach(m=>{
    const g=getCurrentGaze(m);if(!g) return;
    expSamples[m].push({t,x:g.x,y:g.y,dist:Math.hypot(g.x-gtX,g.y-gtY)});
    updateGazeDot(m,g.x,g.y);
  });
}

function finishExperiment(){
  updateGazeDot(null,null,null);
  document.getElementById('exp-dot').classList.remove('show');
  if(wgRunning) try{webgazer.addMouseEventListeners();}catch(_){}
  const run={experimentType:1,timestamp:new Date().toISOString(),wgClicksPerDot:WG_CLICKS_NEEDED,results:{}};
  METHODS.forEach(m=>{
    const dotResults=expResults[m].map((r,i)=>{
      const dists=r.samples.map(s=>s.dist);
      const mean=dists.length?avg(dists):0;
      return{dotIdx:i,gtX:Math.round(r.gtX),gtY:Math.round(r.gtY),pct:r.pct,
        samples:r.samples,heatmapUrl:r.heatmapUrl||null,
        mean:+mean.toFixed(1),min:+(dists.length?Math.min(...dists):0).toFixed(1),
        max:+(dists.length?Math.max(...dists):0).toFixed(1)};
    });
    run.results[m]={dotResults,overallMean:dotResults.length?+(avg(dotResults.map(d=>d.mean))).toFixed(1):0};
  });
  allRuns.push(run);latestRunIdx=allRuns.length-1;
  stopFaceLoop();renderResults(latestRunIdx);showPhase('ph-results');updateRunsList();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPERIMENT 2 â€” WORD READING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startExperiment2(){
  const settleS=parseFloat(document.getElementById('exp2-settle-input')?.value)||0.1;
  const collectS=parseFloat(document.getElementById('exp2-collect-input')?.value)||0.2;
  EXP2_WORD_SKIP_MS=Math.round(Math.max(0.05,settleS)*1000);
  EXP2_WORD_DURATION_MS=EXP2_WORD_SKIP_MS+Math.round(Math.max(0.1,collectS)*1000);
  exp2WordIndex=0;
  exp2Samples={'webgazer':[],'iris-linear':[],'iris-poly':[]};
  exp2Results={'webgazer':[],'iris-linear':[],'iris-poly':[]};
  gazeVisible=false;updateGazeDot(null,null,null);
  const btn2=document.getElementById('btn-toggle-gaze2');
  if(btn2){btn2.textContent='Show Gaze [H]';btn2.style.color='#58a6ff';btn2.style.borderColor='#58a6ff';}
  if(wgRunning) try{webgazer.removeMouseEventListeners();}catch(_){}
  const wrap=document.getElementById('exp2-para-wrap');wrap.innerHTML='';
  EXP2_WORDS.forEach((word,i)=>{
    const span=document.createElement('span');
    span.id='exp2w-'+i;span.className='exp2-word';span.textContent=word+' ';
    wrap.appendChild(span);
  });
  document.getElementById('exp2-progress').textContent='Word 1 / '+EXP2_WORDS.length;
  showPhase('ph-experiment2');
  setTimeout(showNextWord2,600);
}

function showNextWord2(){
  if(exp2WordIndex>=EXP2_WORDS.length){finishExperiment2();return;}
  if(exp2WordIndex>0) document.getElementById('exp2w-'+(exp2WordIndex-1)).className='exp2-word done';
  const span=document.getElementById('exp2w-'+exp2WordIndex);
  span.className='exp2-word active';span.scrollIntoView({behavior:'smooth',block:'center'});
  const rect=span.getBoundingClientRect();
  const gtX=rect.left+rect.width/2,gtY=rect.top+rect.height/2;
  document.getElementById('exp2-progress').textContent='Word '+(exp2WordIndex+1)+' / '+EXP2_WORDS.length;
  const badge=document.getElementById('exp2-collect-badge');
  badge.textContent='Waitingâ€¦';badge.className='exp2-collect-badge';
  METHODS.forEach(m=>exp2Samples[m]=[]);
  exp2WordStart=performance.now();
  let elapsed=0;
  const timerEl=document.getElementById('exp2-timer');
  timerEl.textContent=(EXP2_WORD_DURATION_MS/1000).toFixed(1);
  if(exp2CountdownId) clearInterval(exp2CountdownId);
  exp2CountdownId=setInterval(()=>{
    elapsed+=100;
    timerEl.textContent=Math.max(0,(EXP2_WORD_DURATION_MS-elapsed)/1000).toFixed(1);
    if(elapsed>=EXP2_WORD_DURATION_MS){clearInterval(exp2CountdownId);exp2CountdownId=null;}
  },100);
  setTimeout(()=>{
    badge.textContent='â— Collectingâ€¦';badge.className='exp2-collect-badge collecting';
    exp2SampleId=setInterval(()=>collectGazeSampleExp2(gtX,gtY),SAMPLE_INTERVAL);
  },EXP2_WORD_SKIP_MS);
  exp2WordTimer=setTimeout(()=>{
    clearInterval(exp2SampleId);clearInterval(exp2CountdownId);exp2CountdownId=null;
    updateGazeDot(null,null,null);
    METHODS.forEach(m=>{
      exp2Results[m].push({wordIdx:exp2WordIndex,word:EXP2_WORDS[exp2WordIndex],
        gtX:Math.round(gtX),gtY:Math.round(gtY),
        samples:[...exp2Samples[m]],heatmapUrl:renderHeatmap([...exp2Samples[m]],gtX,gtY)});
    });
    exp2WordIndex++;setTimeout(showNextWord2,200);
  },EXP2_WORD_DURATION_MS);
}

function collectGazeSampleExp2(gtX,gtY){
  const t=(performance.now()-exp2WordStart-EXP2_WORD_SKIP_MS)/1000;
  METHODS.forEach(m=>{
    const g=getCurrentGaze(m);if(!g) return;
    exp2Samples[m].push({t,x:g.x,y:g.y,dist:Math.hypot(g.x-gtX,g.y-gtY)});
    updateGazeDot(m,g.x,g.y);
  });
}

function finishExperiment2(){
  updateGazeDot(null,null,null);
  const lastSpan=document.getElementById('exp2w-'+(EXP2_WORDS.length-1));
  if(lastSpan) lastSpan.className='exp2-word done';
  if(wgRunning) try{webgazer.addMouseEventListeners();}catch(_){}
  const run={experimentType:2,timestamp:new Date().toISOString(),results:{}};
  METHODS.forEach(m=>{
    const wordResults=exp2Results[m].map(r=>{
      const dists=r.samples.map(s=>s.dist);
      const mean=dists.length?avg(dists):0;
      return{wordIdx:r.wordIdx,word:r.word,gtX:r.gtX,gtY:r.gtY,
        samples:r.samples,heatmapUrl:r.heatmapUrl||null,
        mean:+mean.toFixed(1),min:+(dists.length?Math.min(...dists):0).toFixed(1),
        max:+(dists.length?Math.max(...dists):0).toFixed(1)};
    });
    run.results[m]={wordResults,overallMean:wordResults.length?+(avg(wordResults.map(w=>w.mean))).toFixed(1):0};
  });
  allRuns.push(run);latestRunIdx=allRuns.length-1;
  stopFaceLoop();renderResults(latestRunIdx);showPhase('ph-results');updateRunsList();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPERIMENT 3 â€” OFF-SCREEN ROBUSTNESS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startExperiment3(){
  exp3DirIndex=0;exp3Results=[];
  exp3Samples={'webgazer':[],'iris-linear':[],'iris-poly':[]};
  gazeVisible=false;updateGazeDot(null,null,null);
  if(wgRunning) try{webgazer.removeMouseEventListeners();}catch(_){}
  showPhase('ph-experiment3');setTimeout(showNextDirection3,600);
}

function showNextDirection3(){
  if(exp3DirIndex>=EXP3_DIRECTIONS.length){finishExperiment3();return;}
  const dir=EXP3_DIRECTIONS[exp3DirIndex];
  document.getElementById('exp3-bg').style.background=dir.bg;
  document.getElementById('exp3-arrow').textContent=dir.arrow;
  document.getElementById('exp3-instruction').textContent='Look '+dir.label;
  document.getElementById('exp3-subtext').textContent=dir.subtext;
  document.getElementById('exp3-progress').textContent='Direction '+(exp3DirIndex+1)+' / '+EXP3_DIRECTIONS.length;
  document.getElementById('exp3-proceed-btn').style.display='none';
  const badge=document.getElementById('exp3-badge');
  const timerEl=document.getElementById('exp3-timer-wrap');
  badge.textContent='Waitingâ€¦';badge.style.background='rgba(248,81,73,.25)';badge.style.color='#f85149';
  timerEl.textContent=(EXP3_DURATION_MS/1000).toFixed(0);
  METHODS.forEach(m=>exp3Samples[m]=[]);
  exp3DirStart=performance.now();
  let elapsed=0;
  if(exp3CountdownId) clearInterval(exp3CountdownId);
  exp3CountdownId=setInterval(()=>{
    elapsed+=100;
    timerEl.textContent=Math.max(0,Math.ceil((EXP3_DURATION_MS-elapsed)/1000));
    if(elapsed>=EXP3_DURATION_MS){clearInterval(exp3CountdownId);exp3CountdownId=null;}
  },100);
  setTimeout(()=>{
    badge.textContent='â— Collectingâ€¦';badge.style.background='rgba(63,185,80,.25)';badge.style.color='#3fb950';
    exp3SampleId=setInterval(collectGazeSampleExp3,SAMPLE_INTERVAL);
  },EXP3_SKIP_MS);
  exp3TimerId=setTimeout(()=>{
    clearInterval(exp3SampleId);exp3SampleId=null;
    clearInterval(exp3CountdownId);exp3CountdownId=null;
    updateGazeDot(null,null,null);
    const W=window.innerWidth,H=window.innerHeight;
    const methodData={};
    METHODS.forEach(m=>{
      const samps=exp3Samples[m];
      const onScreen=samps.filter(s=>s.x>=0&&s.x<=W&&s.y>=0&&s.y<=H).length;
      methodData[m]={samples:[...samps],onScreen,total:samps.length,heatmapUrl:renderHeatmapExp3([...samps])};
    });
    exp3Results.push({dirIdx:exp3DirIndex,dirId:dir.id,dirLabel:dir.label,dirArrow:dir.arrow,methods:methodData});
    badge.textContent='âœ“ Done';badge.style.background='rgba(88,166,255,.2)';badge.style.color='#58a6ff';
    timerEl.textContent='0';document.getElementById('exp3-proceed-btn').style.display='block';
  },EXP3_DURATION_MS);
}

function collectGazeSampleExp3(){
  const t=(performance.now()-exp3DirStart-EXP3_SKIP_MS)/1000;
  METHODS.forEach(m=>{
    const g=getCurrentGaze(m);if(!g) return;
    exp3Samples[m].push({t,x:g.x,y:g.y});updateGazeDot(m,g.x,g.y);
  });
}
function exp3Proceed(){document.getElementById('exp3-proceed-btn').style.display='none';exp3DirIndex++;showNextDirection3();}

function finishExperiment3(){
  updateGazeDot(null,null,null);
  if(wgRunning) try{webgazer.addMouseEventListeners();}catch(_){}
  const run={experimentType:3,timestamp:new Date().toISOString(),results:{}};
  METHODS.forEach(m=>{
    const totalOnScreen=exp3Results.reduce((s,r)=>s+(r.methods[m]?.onScreen||0),0);
    const totalSamples=exp3Results.reduce((s,r)=>s+(r.methods[m]?.total||0),0);
    const leakageRate=totalSamples?+(totalOnScreen/totalSamples*100).toFixed(1):0;
    run.results[m]={
      dirResults:exp3Results.map(r=>({dirIdx:r.dirIdx,dirId:r.dirId,dirLabel:r.dirLabel,dirArrow:r.dirArrow,...r.methods[m]})),
      totalOnScreen,totalSamples,leakageRate
    };
  });
  allRuns.push(run);latestRunIdx=allRuns.length-1;
  stopFaceLoop();renderResults(latestRunIdx);showPhase('ph-results');updateRunsList();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULTS RENDERING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderResults(runIdx){
  const run=allRuns[runIdx];if(!run) return;
  chartInstances.forEach(c=>c.destroy());chartInstances=[];
  if(compChartInst){compChartInst.destroy();compChartInst=null;}
  const d=new Date(run.timestamp);
  const timeStr=d.toLocaleDateString()+' '+d.toLocaleTimeString();
  if(run.experimentType===1) renderResultsExp1(run,timeStr);
  else if(run.experimentType===2) renderResultsExp2(run,timeStr);
  else if(run.experimentType===3) renderResultsExp3(run,timeStr);
}

function buildSummaryCards(run,metricFn,unitFn,labelFn,colorFn){
  const cards=document.getElementById('method-summary-cards');cards.innerHTML='';
  METHODS.forEach(m=>{
    const mr=run.results[m];
    const val=mr?metricFn(mr):'â€“';
    const color=mr&&colorFn?colorFn(mr):'#e6edf3';
    const card=document.createElement('div');
    card.className='ms-card '+METHOD_CSS[m];
    card.innerHTML=`<h4>${METHOD_LABELS[m]}</h4>
      <div class="ms-big" style="color:${color}">${val}<small style="font-size:1rem;color:#8b949e"> ${unitFn?unitFn(mr):''}</small></div>
      <div class="ms-label">${labelFn}</div>`;
    cards.appendChild(card);
  });
}

function buildGroupedChart(labels,datasetsData,yLabel){
  const datasets=METHODS.map((m,mi)=>({
    label:METHOD_LABELS[m],data:datasetsData[mi],
    backgroundColor:METHOD_COLORS[m]+'b3',borderColor:METHOD_COLORS[m],borderWidth:1
  }));
  const cctx=document.getElementById('comparison-chart').getContext('2d');
  compChartInst=new Chart(cctx,{
    type:'bar',data:{labels,datasets},
    options:{
      animation:false,
      plugins:{legend:{labels:{color:'#e6edf3',font:{size:11}}}},
      scales:{
        x:{ticks:{color:'#8b949e',font:{size:9},maxRotation:45},grid:{color:'#21262d'}},
        y:{ticks:{color:'#8b949e'},grid:{color:'#21262d'},beginAtZero:true,
           title:{display:true,text:yLabel,color:'#8b949e',font:{size:11}}}
      }
    }
  });
}

function renderResultsExp1(run,timeStr){
  document.getElementById('res-title').textContent='Exp 1 â€” Fixation Accuracy';
  document.getElementById('res-subtitle').textContent=timeStr+'   |   Cal: '+run.wgClicksPerDot+' clicks/dot';
  buildSummaryCards(run,mr=>mr.overallMean,()=>'px','Overall Mean Error',
    mr=>mr.overallMean<80?'#3fb950':mr.overallMean<160?'#f0c000':'#f85149');

  document.getElementById('sec-chart-title').textContent='Mean Gaze Error per Dot â€” All 3 Methods';
  const dotLabels=CAL_POSITIONS_PCT.map((_,i)=>'Dot '+(i+1)).concat(['Overall']);
  const datasetsData=METHODS.map(m=>{const mr=run.results[m];return mr?(mr.dotResults.map(d=>d.mean).concat([mr.overallMean])):Array(10).fill(0);});
  buildGroupedChart(dotLabels,datasetsData,'Mean Error (px)');

  document.getElementById('sec-table-title').textContent='Per-Dot Results â€” All 3 Methods';
  const thead=document.getElementById('results-thead');
  thead.innerHTML='<th>Dot</th><th>Position</th>'+
    METHODS.map(m=>`<th style="color:${METHOD_COLORS[m]}">${METHOD_LABELS[m]} (px)</th>`).join('')+
    METHODS.map(m=>`<th style="color:${METHOD_COLORS[m]};opacity:.6">N</th>`).join('');
  const tbody=document.getElementById('results-tbody');tbody.innerHTML='';
  for(let i=0;i<9;i++){
    const tr=document.createElement('tr');
    const anyM=run.results[METHODS[0]];
    const pos=anyM?`(${anyM.dotResults[i]?.gtX},${anyM.dotResults[i]?.gtY})`:'â€“';
    let cells=`<td>Dot ${i+1}</td><td style="color:#8b949e;font-size:.8rem">${pos}</td>`;
    METHODS.forEach(m=>{
      const dr=run.results[m]?.dotResults[i];
      const c=dr?(dr.mean<80?'#3fb950':dr.mean<160?'#f0c000':'#f85149'):'#8b949e';
      cells+=`<td style="color:${c};font-weight:600">${dr?dr.mean:'â€“'}</td>`;
    });
    METHODS.forEach(m=>{const dr=run.results[m]?.dotResults[i];cells+=`<td style="color:#8b949e">${dr?dr.samples.length:'â€“'}</td>`;});
    tr.innerHTML=cells;tbody.appendChild(tr);
  }
  const tr=document.createElement('tr');tr.className='total';
  let tcells='<td colspan="2">Overall Average</td>';
  METHODS.forEach(m=>{tcells+=`<td>${run.results[m]?.overallMean||'â€“'}</td>`;});
  METHODS.forEach(m=>{const mr=run.results[m];tcells+=`<td>${mr?mr.dotResults.reduce((s,d)=>s+d.samples.length,0):'â€“'}</td>`;});
  tr.innerHTML=tcells;tbody.appendChild(tr);

  // Heatmap grid
  document.getElementById('sec-heatmaps').style.display='block';
  document.getElementById('sec-heatmaps-title').textContent='Heatmaps â€” Dot Ã— Method';
  buildHeatmapGrid(9,(i)=>'Dot '+(i+1),(i,m)=>{
    const dr=run.results[m]?.dotResults[i];
    return dr?{url:dr.heatmapUrl,caption:''}:null;
  });
}

function renderResultsExp2(run,timeStr){
  document.getElementById('res-title').textContent='Exp 2 â€” Reading Task';
  document.getElementById('res-subtitle').textContent=timeStr+'   |   '+EXP2_WORDS.length+' words';
  buildSummaryCards(run,mr=>mr.overallMean,()=>'px','Overall Mean Error',
    mr=>mr.overallMean<80?'#3fb950':mr.overallMean<160?'#f0c000':'#f85149');

  const maxWords=Math.min(30,EXP2_WORDS.length);
  document.getElementById('sec-chart-title').textContent='Mean Gaze Error per Word â€” All 3 Methods (first '+maxWords+' words)';
  const wordLabels=EXP2_WORDS.slice(0,maxWords).map(w=>'"'+w+'"').concat(['Overall']);
  const datasetsData=METHODS.map(m=>{const mr=run.results[m];return mr?(mr.wordResults.slice(0,maxWords).map(w=>w.mean).concat([mr.overallMean])):Array(maxWords+1).fill(0);});
  buildGroupedChart(wordLabels,datasetsData,'Mean Error (px)');

  document.getElementById('sec-table-title').textContent='Per-Word Results â€” All 3 Methods';
  const thead=document.getElementById('results-thead');
  thead.innerHTML='<th>#</th><th>Word</th>'+METHODS.map(m=>`<th style="color:${METHOD_COLORS[m]}">${METHOD_LABELS[m]} (px)</th>`).join('');
  const tbody=document.getElementById('results-tbody');tbody.innerHTML='';
  const nWords=run.results[METHODS[0]]?.wordResults?.length||0;
  for(let i=0;i<nWords;i++){
    const tr=document.createElement('tr');
    const word=run.results[METHODS[0]].wordResults[i]?.word||'â€“';
    let cells=`<td>${i+1}</td><td style="color:#8b949e">&ldquo;${word}&rdquo;</td>`;
    METHODS.forEach(m=>{
      const wr=run.results[m]?.wordResults[i];
      const c=wr?(wr.mean<80?'#3fb950':wr.mean<160?'#f0c000':'#f85149'):'#8b949e';
      cells+=`<td style="color:${c};font-weight:600">${wr?wr.mean:'â€“'}</td>`;
    });
    tr.innerHTML=cells;tbody.appendChild(tr);
  }
  const tr=document.createElement('tr');tr.className='total';
  let tcells='<td colspan="2">Overall Average</td>';
  METHODS.forEach(m=>{tcells+=`<td>${run.results[m]?.overallMean||'â€“'}</td>`;});
  tr.innerHTML=tcells;tbody.appendChild(tr);
  document.getElementById('sec-heatmaps').style.display='none';
}

function renderResultsExp3(run,timeStr){
  document.getElementById('res-title').textContent='Exp 3 â€” Off-Screen Robustness';
  const summaries=METHODS.map(m=>{const mr=run.results[m];return mr?METHOD_LABELS[m]+': '+mr.leakageRate+'%':'â€“';}).join('  |  ');
  document.getElementById('res-subtitle').textContent=timeStr+'   |   '+summaries+' leakage';
  buildSummaryCards(run,mr=>mr.leakageRate,()=>'%','Leakage Rate (lower = better)',
    mr=>mr.leakageRate<20?'#3fb950':mr.leakageRate<50?'#f0c000':'#f85149');

  document.getElementById('sec-chart-title').textContent='On-Screen Sample Count per Direction â€” All 3 Methods (lower = better)';
  const dirLabels=EXP3_DIRECTIONS.map(d=>d.arrow+' '+d.label).concat(['Total']);
  const datasetsData=METHODS.map(m=>{const mr=run.results[m];return mr?(mr.dirResults.map(dr=>dr.onScreen).concat([mr.totalOnScreen])):[0,0,0,0,0];});
  buildGroupedChart(dirLabels,datasetsData,'On-screen sample count');

  document.getElementById('sec-table-title').textContent='Per-Direction Leakage â€” All 3 Methods';
  const thead=document.getElementById('results-thead');
  thead.innerHTML='<th>Direction</th>'+METHODS.map(m=>`<th style="color:${METHOD_COLORS[m]}">${METHOD_LABELS[m]}<br><small>On/Total (%)</small></th>`).join('');
  const tbody=document.getElementById('results-tbody');tbody.innerHTML='';
  EXP3_DIRECTIONS.forEach((dir,i)=>{
    const tr=document.createElement('tr');
    let cells=`<td>${dir.arrow} ${dir.label}</td>`;
    METHODS.forEach(m=>{
      const dr=run.results[m]?.dirResults[i];
      if(dr){
        const pct=dr.total?+(dr.onScreen/dr.total*100).toFixed(1):0;
        const c=pct<20?'#3fb950':pct<50?'#f0c000':'#f85149';
        cells+=`<td><span style="color:${c};font-weight:600">${dr.onScreen}/${dr.total}</span> <span style="color:#8b949e">(${pct}%)</span></td>`;
      } else cells+='<td style="color:#8b949e">â€“</td>';
    });
    tr.innerHTML=cells;tbody.appendChild(tr);
  });
  const tr=document.createElement('tr');tr.className='total';
  let tcells='<td>Total</td>';
  METHODS.forEach(m=>{const mr=run.results[m];tcells+=mr?`<td>${mr.totalOnScreen}/${mr.totalSamples} (${mr.leakageRate}%)</td>`:'<td>â€“</td>';});
  tr.innerHTML=tcells;tbody.appendChild(tr);

  document.getElementById('sec-heatmaps').style.display='block';
  document.getElementById('sec-heatmaps-title').textContent='Heatmaps â€” Direction Ã— Method (blue border = screen)';
  buildHeatmapGrid(EXP3_DIRECTIONS.length,(i)=>EXP3_DIRECTIONS[i].arrow+' '+EXP3_DIRECTIONS[i].label,(i,m)=>{
    const dr=run.results[m]?.dirResults[i];
    if(!dr) return null;
    const pct=dr.total?+(dr.onScreen/dr.total*100).toFixed(1):0;
    return{url:dr.heatmapUrl,caption:`${dr.onScreen}/${dr.total} (${pct}%)`};
  });
}

function buildHeatmapGrid(nRows,rowLabelFn,cellFn){
  const hc=document.getElementById('heatmaps-container');hc.innerHTML='';
  const hdr=document.createElement('div');hdr.className='hm-header-row cols3';
  hdr.innerHTML=METHODS.map(m=>`<div style="font-size:.8rem;font-weight:700;color:${METHOD_COLORS[m]};text-align:center;padding:4px">${METHOD_LABELS[m]}</div>`).join('');
  hc.appendChild(hdr);
  for(let i=0;i<nRows;i++){
    const rowLabel=document.createElement('div');rowLabel.className='hm-row-label';rowLabel.textContent=rowLabelFn(i);
    hc.appendChild(rowLabel);
    const row=document.createElement('div');row.className='hm-grid cols3';
    METHODS.forEach(m=>{
      const info=cellFn(i,m);
      const cell=document.createElement('div');cell.className='hm-cell';
      if(info&&info.url){
        cell.innerHTML=(info.caption?`<div style="font-size:.65rem;color:#8b949e;margin-bottom:2px">${info.caption}</div>`:'')+
          `<img src="${info.url}" style="width:100%;height:auto;border-radius:4px"/>`;
      } else {
        cell.innerHTML='<div style="height:50px;display:flex;align-items:center;justify-content:center;color:#8b949e;font-size:.7rem">No data</div>';
      }
      row.appendChild(cell);
    });
    hc.appendChild(row);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RUNS LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateRunsList(){
  const wrap=document.getElementById('runs-list');
  const inner=document.getElementById('runs-list-inner');
  if(!allRuns.length){wrap.style.display='none';return;}
  wrap.style.display='block';inner.innerHTML='';
  allRuns.forEach((run,i)=>{
    const el=document.createElement('div');el.className='run-item';
    const d=new Date(run.timestamp);
    const scores=METHODS.map(m=>{
      const mr=run.results[m];if(!mr) return '';
      const val=run.experimentType===3?mr.leakageRate+'%':mr.overallMean+'px';
      return`<span class="ri-score" style="color:${METHOD_COLORS[m]}">${val}</span>`;
    }).join('<span style="color:#30363d;margin:0 2px">|</span>');
    el.innerHTML=`<span class="ri-exp">[Exp${run.experimentType}]</span>
      <div class="ri-scores">${scores}</div>
      <span class="ri-time">${d.toLocaleTimeString()}</span>`;
    el.onclick=()=>{latestRunIdx=i;renderResults(i);showPhase('ph-results');};
    inner.appendChild(el);
  });
}
function clearAllRuns(){
  allRuns=[];latestRunIdx=-1;
  chartInstances.forEach(c=>c.destroy());chartInstances=[];
  if(compChartInst){compChartInst.destroy();compChartInst=null;}
  updateRunsList();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVE / SCREENSHOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function takeScreenshot(){
  if(typeof html2canvas==='undefined'){showToast('html2canvas not loaded');return;}
  showToast('Capturingâ€¦');
  try{
    const canvas=await html2canvas(document.getElementById('ph-results'),
      {backgroundColor:'#0d1117',scale:window.devicePixelRatio||1,logging:false,useCORS:true,allowTaint:true});
    const ts=new Date().toISOString().replace(/[:.]/g,'-').slice(0,19);
    const a=document.createElement('a');a.href=canvas.toDataURL('image/png');a.download=`screenshot_${ts}.png`;a.click();
    showToast('Screenshot saved!');
  }catch(e){showToast('Screenshot failed: '+e.message);}
}

function saveResults(){
  if(!allRuns.length) return;
  const ts=new Date().toISOString().replace(/[:.]/g,'-').slice(0,19);
  const payload={exportedAt:new Date().toISOString(),screenWidth:window.innerWidth,screenHeight:window.innerHeight,
    runs:allRuns.map(run=>{
      const base={experimentType:run.experimentType,timestamp:run.timestamp,results:{}};
      if(run.wgClicksPerDot) base.wgClicksPerDot=run.wgClicksPerDot;
      METHODS.forEach(m=>{
        const mr=run.results[m];if(!mr){base.results[m]=null;return;}
        if(run.experimentType===3){
          base.results[m]={leakageRate:mr.leakageRate,totalOnScreen:mr.totalOnScreen,totalSamples:mr.totalSamples,
            directions:mr.dirResults.map(dr=>({direction:dr.dirLabel,arrow:dr.dirArrow,onScreen:dr.onScreen,total:dr.total,
              leakagePct:dr.total?+(dr.onScreen/dr.total*100).toFixed(1):0,timeSeries:dr.samples}))};
        } else if(run.experimentType===2){
          base.results[m]={overallMean:mr.overallMean,words:mr.wordResults.map(w=>({idx:w.wordIdx+1,word:w.word,
            gtX:w.gtX,gtY:w.gtY,meanError:w.mean,minError:w.min,maxError:w.max,sampleCount:w.samples.length,timeSeries:w.samples}))};
        } else {
          base.results[m]={overallMean:mr.overallMean,dots:mr.dotResults.map(dr=>({dotIdx:dr.dotIdx+1,pct:dr.pct,
            gtX:dr.gtX,gtY:dr.gtY,meanError:dr.mean,minError:dr.min,maxError:dr.max,sampleCount:dr.samples.length,timeSeries:dr.samples}))};
        }
      });
      return base;
    })};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`gaze_experiment_${ts}.json`;a.click();URL.revokeObjectURL(url);

  const latestRun=allRuns[latestRunIdx];
  if(latestRun){
    let csv='';
    if(latestRun.experimentType===3){
      csv='Method,Direction,OnScreen,Total,LeakagePct\n';
      METHODS.forEach(m=>{const mr=latestRun.results[m];if(!mr) return;
        mr.dirResults.forEach(dr=>{const pct=dr.total?+(dr.onScreen/dr.total*100).toFixed(1):0;
          csv+=`"${METHOD_LABELS[m]}","${dr.dirLabel}",${dr.onScreen},${dr.total},${pct}\n`;});});
    } else if(latestRun.experimentType===2){
      csv='Method,WordIdx,Word,GroundTruthX,GroundTruthY,MeanError_px,MinError_px,MaxError_px,Samples\n';
      METHODS.forEach(m=>{const mr=latestRun.results[m];if(!mr) return;
        mr.wordResults.forEach(w=>{csv+=`"${METHOD_LABELS[m]}",${w.wordIdx+1},"${w.word}",${w.gtX},${w.gtY},${w.mean},${w.min},${w.max},${w.samples.length}\n`;});});
    } else {
      csv='Method,Dot,PctX,PctY,GroundTruthX,GroundTruthY,MeanError_px,MinError_px,MaxError_px,Samples\n';
      METHODS.forEach(m=>{const mr=latestRun.results[m];if(!mr) return;
        mr.dotResults.forEach(dr=>{csv+=`"${METHOD_LABELS[m]}",${dr.dotIdx+1},${dr.pct[0]},${dr.pct[1]},${dr.gtX},${dr.gtY},${dr.mean},${dr.min},${dr.max},${dr.samples.length}\n`;});});
    }
    const csvBlob=new Blob([csv],{type:'text/csv'});
    const csvUrl=URL.createObjectURL(csvBlob);
    const b=document.createElement('a');b.href=csvUrl;b.download=`gaze_experiment_${ts}.csv`;b.click();URL.revokeObjectURL(csvUrl);

    if(latestRun.experimentType!==2){
      let hi=0;
      METHODS.forEach(m=>{const mr=latestRun.results[m];if(!mr) return;
        const items=latestRun.experimentType===3?mr.dirResults:mr.dotResults;
        const prefix=latestRun.experimentType===3?'dir':'dot';
        items.forEach((item,i)=>{if(!item.heatmapUrl) return;
          const a=document.createElement('a');a.href=item.heatmapUrl;
          a.download=`heatmap_${m}_${prefix}${i+1}_${ts}.png`;
          setTimeout(()=>a.click(),200+hi*100);hi++;});});
    }
  }
  showToast('Saved JSON + CSV!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD + INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown',e=>{if(e.key==='h'||e.key==='H') toggleGazeDot();});

window.addEventListener('load',async()=>{
  try{
    videoEl=document.getElementById('cam-preview');
    camStream=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480,facingMode:'user'}});
    videoEl.srcObject=camStream;
    await new Promise(r=>videoEl.addEventListener('loadeddata',r,{once:true}));
    document.getElementById('cam-status').textContent='Camera active â€” face landmarks shown';
    if(typeof FaceMesh!=='undefined'){await initFaceMesh();startFaceLoop();startSelectDraw();}
  }catch(e){document.getElementById('cam-status').textContent='Camera: '+(e.message||e);}
});

window.addEventListener('beforeunload',()=>{
  if(wgRunning) try{webgazer.end();}catch(_){}
  stopFaceLoop();
  if(camStream) camStream.getTracks().forEach(t=>t.stop());
});
</script>
</body>
</html>
